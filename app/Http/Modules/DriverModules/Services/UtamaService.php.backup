<?php

namespace App\Http\Modules\DriverModules\Services;

use App\Services\DriverApi;
use App\Services\OrderApi;
use App\Services\OrderUpdateApi;
use App\Services\TrackingUpdate;
use Illuminate\Support\Facades\DB;

class UtamaService
{

    public static function checkStatus(array $orderDetail, string $except)
    {
        $status = $orderDetail['Status'] ?? null;

        $map = [
            '' => 'menu.detail-order',
            'EXECUTE' => 'menu.detail-order',
            'LOADOTW' => 'utama.konfirmasi-tiba-muat',
            'LOADWAIT' => 'utama.konfirmasi-mulai-muat',
            'LOAD' => 'utama.konfirmasi-selesai-muat',
            'SHIPMENT' => 'utama.konfirmasi-tiba-tujuan',
            'UNLOADWAIT' => 'utama.konfirmasi-mulai-bongkar',
            'UNLOAD' => 'utama.konfirmasi-keluar-bongkar',
            'FINISHED' => 'menu.list-order',
        ];

        if ($status && isset($map[$status]) && $status !== $except) {
            return redirect()->route($map[$status], [
                'orderId' => $orderDetail['XX_TransOrder_ID'] ?? null,
            ]);
        }

        return null;
    }


    public static function getDriverData($c_bpartner_id, DriverApi $driverApi)
    {
        $driver = $driverApi->getDriver($c_bpartner_id);

        $fields = data_get($driver, 'soap:Body.ns1:queryDataResponse.WindowTabData.DataSet.DataRow.field', []);
        if (isset($fields['@attributes'])) {
            $fields = [$fields];
        }

        $mappedDriver = [];
        foreach ($fields as $f) {
            $attr = $f['@attributes'] ?? [];
            if (isset($attr['column'], $attr['lval'])) {
                $mappedDriver[$attr['column']] = $attr['lval'];
            }
        }

        return $mappedDriver;
    }


    public static function getOrderList($driverId, OrderApi $orderApi)
    {
        $order = $orderApi->getOrderList($driverId, 'N');

        $rows = data_get($order, 'soap:Body.ns1:queryDataResponse.WindowTabData.DataSet.DataRow', []);
        if (isset($rows['field'])) {
            $rows = [$rows];
        }

        $mappedOrders = [];
        foreach ($rows as $row) {
            $fs = $row['field'] ?? [];
            if (isset($fs['@attributes'])) {
                $fs = [$fs];
            }

            $tmp = [];
            foreach ($fs as $f) {
                $attr = $f['@attributes'] ?? [];
                if (isset($attr['column'], $attr['lval'])) {
                    $tmp[$attr['column']] = $attr['lval'];
                }
            }
            if (!empty($tmp)) {
                $mappedOrders[] = $tmp;
            }
        }

        return $mappedOrders;
    }

    public static function enrichOrdersData(array $mappedOrders)
    {
        $customerIds = collect($mappedOrders)->pluck('Customer_ID')->filter()->unique();
        $transOrderIds = collect($mappedOrders)->pluck('XX_TransOrder_ID')->filter()->unique();

        $customers = DB::table('mzl.c_bpartner')
            ->whereIn('c_bpartner_id', $customerIds)
            ->pluck('name', 'c_bpartner_id');

        $routes = DB::table('mzl.xx_transorder as t')
            ->select('t.xx_transorder_id', 't.route')
            ->whereIn('t.xx_transorder_id', $transOrderIds)
            ->get()
            ->keyBy('xx_transorder_id');

        return collect($mappedOrders)
            ->filter(function ($r) {
                return !isset($r['Status']) || $r['Status'] !== 'FINISHED';
            })
            ->sortByDesc(function ($r) {
                return $r['ETD'] ?? '9999-12-31 23:59:59';
            })
            ->values()
            ->map(function ($r) use ($customers, $routes) {
                $r['Customer_Name'] = $customers[$r['Customer_ID']] ?? '-';
                $route = $routes[$r['XX_TransOrder_ID']] ?? null;
                $r['route'] = $route->route ?? '-';
                return $r;
            })
            ->all();
    }


    public static function getOrderDetail($orderId, OrderApi $orderApi)
    {
        $detailOrder = $orderApi->getOrderDetail($orderId);

        $row = data_get($detailOrder, 'soap:Body.ns1:queryDataResponse.WindowTabData.DataSet.DataRow', []);
        $fields = data_get($row, 'field', []);

        if (isset($fields['@attributes'])) {
            $fields = [$fields];
        }

        $mappedDetail = [];
        foreach ($fields as $f) {
            $attr = $f['@attributes'] ?? [];
            if (isset($attr['column'])) {
                $mappedDetail[$attr['column']] = $attr['lval'] ?? null;
            }
        }

        return $mappedDetail;
    }


    public static function enrichOrderDetail(array $mappedDetail, $orderId, OrderApi $orderApi)
    {
        $customerId = $mappedDetail['Customer_ID'] ?? null;
        $mappedDetail['Customer_Name'] = $customerId
            ? DB::table('mzl.c_bpartner')->where('c_bpartner_id', $customerId)->value('name')
            : '-';

        $detailTransOrder = $orderApi->getTransOrderWithCustomerAddress($orderId);

        $mappedDetail["pickup_address"] = $detailTransOrder->pickup_address ?? "-";
        $mappedDetail["delivery_address"] = $detailTransOrder->delivery_address ?? "-";
        $mappedDetail['route'] = $detailTransOrder->route ?? "-";

        return $mappedDetail;
    }


    public static function updateBerangkat($orderId, $kmTake, TrackingUpdate $trackingUpdate, OrderUpdateApi $orderUpdate)
    {
        $updateTracking = $trackingUpdate->UpdateTracking($orderId, [
            'Status' => 'LOADOTW',
            'Note' => 'driver confirmation',
            'Reference' => 'AUD',
            'KMTake' => $kmTake,
            'DateDoc' => now()->format('Y-m-d H:i:s'),
        ]);

        if (is_array($updateTracking) && isset($updateTracking['Error'])) {
            return [
                'success' => false,
                'message' => is_array($updateTracking['Error'])
                    ? json_encode($updateTracking['Error'])
                    : $updateTracking['Error']
            ];
        }

        $updateStatus = $orderUpdate->updateOrder($orderId, [
            'Status' => 'LOADOTW',
        ]);

        if (is_array($updateStatus) && isset($updateStatus['Error'])) {
            return [
                'success' => false,
                'message' => is_array($updateStatus['Error'])
                    ? json_encode($updateStatus['Error'])
                    : $updateStatus['Error']
            ];
        }

        return [
            'success' => true,
            'data' => $updateTracking,
            'message' => 'Status diubah ke LOADOTW.'
        ];
    }


    public static function updateTibaMuat($orderId, OrderUpdateApi $orderUpdate, TrackingUpdate $trackingUpdate)
    {
        $update = $orderUpdate->updateOrder($orderId, [
            'Status' => 'LOADWAIT',
            'LoadDate' => now()->format('Y-m-d H:i:s'),
        ]);

        if (is_array($update) && isset($update['Error'])) {
            return [
                'success' => false,
                'message' => is_array($update['Error'])
                    ? json_encode($update['Error'])
                    : $update['Error']
            ];
        }

        $updateTracking = $trackingUpdate->UpdateTracking($orderId, [
            'Status' => 'LOADWAIT',
            'Note' => 'driver confirmation',
            'Reference' => 'AUD',
            'DateDoc' => now()->format('Y-m-d H:i:s'),
        ]);

        return [
            'success' => true,
            'message' => 'Status diubah ke LOADWAIT.'
        ];
    }


    public static function updateMulaiMuat($orderId, OrderUpdateApi $orderUpdate, TrackingUpdate $trackingUpdate)
    {
        $update = $orderUpdate->updateOrder($orderId, [
            'Status' => 'LOAD',
            'LoadDateStart' => now()->format('Y-m-d H:i:s'),
        ]);

        if (is_array($update) && isset($update['Error'])) {
            return [
                'success' => false,
                'message' => is_array($update['Error'])
                    ? json_encode($update['Error'])
                    : $update['Error']
            ];
        }

        $updateTracking = $trackingUpdate->UpdateTracking($orderId, [
            'Status' => 'LOAD',
            'Note' => 'driver confirmation',
            'Reference' => 'AUD',
            'DateDoc' => now()->format('Y-m-d H:i:s'),
        ]);

        return [
            'success' => true,
            'message' => 'Status diubah ke LOAD.'
        ];
    }


    public static function updateSelesaiMuat($orderId, $fotoSupirPath, $dokumenFilePath, OrderUpdateApi $orderUpdate, TrackingUpdate $trackingUpdate)
    {
        $update = $orderUpdate->updateOrder($orderId, [
            'Status' => 'SHIPMENT',
            'OutLoadDate' => now()->format('Y-m-d H:i:s'),
        ]);

        if (is_array($update) && isset($update['Error'])) {
            return [
                'success' => false,
                'message' => is_array($update['Error'])
                    ? json_encode($update['Error'])
                    : $update['Error']
            ];
        }

        $updateTracking = $trackingUpdate->UpdateTracking($orderId, [
            'Status' => 'SHIPMENT',
            'Note' => 'driver confirmation',
            'Reference' => 'AUD',
            'DateDoc' => now()->format('Y-m-d H:i:s'),
            'DocumentDir' => $fotoSupirPath,
            'DocumentDir2' => $dokumenFilePath
        ]);

        return [
            'success' => true,
            'message' => 'Status diubah ke SHIPMENT.',
            'debug_update' => $update,
            'debug_tracking' => $updateTracking
        ];
    }


    public static function updateTibaTujuan($orderId, OrderUpdateApi $orderUpdate, TrackingUpdate $trackingUpdate)
    {
        $update = $orderUpdate->updateOrder($orderId, [
            'Status' => 'UNLOADWAIT',
            'UnloadDate' => now()->format('Y-m-d H:i:s'),
        ]);

        if (is_array($update) && isset($update['Error'])) {
            return [
                'success' => false,
                'message' => is_array($update['Error'])
                    ? json_encode($update['Error'])
                    : $update['Error']
            ];
        }

        $updateTracking = $trackingUpdate->UpdateTracking($orderId, [
            'Status' => 'UNLOADWAIT',
            'Note' => 'driver confirmation',
            'Reference' => 'AUD',
            'DateDoc' => now()->format('Y-m-d H:i:s'),
        ]);

        return [
            'success' => true,
            'message' => 'Status diubah ke UNLOADWAIT'
        ];
    }


    public static function updateMulaiBongkar($orderId, $fotoMuatanPath, OrderUpdateApi $orderUpdate, TrackingUpdate $trackingUpdate)
    {
        $update = $orderUpdate->updateOrder($orderId, [
            'Status' => 'UNLOAD',
            'UnloadDateStart' => now()->format('Y-m-d H:i:s'),
        ]);

        if (is_array($update) && isset($update['Error'])) {
            return [
                'success' => false,
                'message' => is_array($update['Error'])
                    ? json_encode($update['Error'])
                    : $update['Error']
            ];
        }

        $updateTracking = $trackingUpdate->UpdateTracking($orderId, [
            'Status' => 'UNLOAD',
            'Note' => 'driver confirmation',
            'Reference' => 'AUD',
            'DateDoc' => now()->format('Y-m-d H:i:s'),
            'DocumentDir' => $fotoMuatanPath
        ]);

        return [
            'success' => true,
            'message' => 'Status diubah ke UNLOAD',
            'debug_update' => $update,
            'debug_tracking' => $updateTracking
        ];
    }


    public static function updateKeluarBongkar($orderId, $fotoSuratJalanPath, OrderUpdateApi $orderUpdate, TrackingUpdate $trackingUpdate)
    {
        $updateTracking = $trackingUpdate->UpdateTracking($orderId, [
            'Status' => 'FINISHED',
            'Note' => 'driver confirmation',
            'Reference' => 'AUD',
            'DateDoc' => now()->format('Y-m-d H:i:s'),
            'DocumentDir' => $fotoSuratJalanPath,
        ]);

        if (is_array($updateTracking) && isset($updateTracking['error'])) {
            return [
                'success' => false,
                'message' => is_array($updateTracking['error'])
                    ? json_encode($updateTracking['error'])
                    : $updateTracking['error']
            ];
        }

        $update = $orderUpdate->updateOrder($orderId, [
            'Status' => 'FINISHED',
            'OutUnloadDate' => now()->format('Y-m-d H:i:s'),
        ]);

        if (is_array($update) && isset($update['error'])) {
            return [
                'success' => false,
                'message' => is_array($update['error'])
                    ? json_encode($update['error'])
                    : $update['error']
            ];
        }

        return [
            'success' => true,
            'data' => $update,
            'message' => 'Status diubah ke FINISHED'
        ];
    }
}
